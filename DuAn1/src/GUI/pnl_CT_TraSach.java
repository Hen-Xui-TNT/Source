/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package GUI;

import BLL.BLL_Combobox;
import BLL.BLL_PhieuPhat;
import BLL.BLL_PhieuThue;
import BLL.BLL_TraSach;
import BLL.ChuyenDoi_ThongBao;
import DAL.DAL_ChiTietPhieuPhat;
import DAL.DAL_ChiTietPhieuThue;
import DAL.DAL_PhieuPhat;
import DAL.DAL_PhieuThue;
import DTO.DTO_ChiTietPhieuPhat;
import DTO.DTO_ChiTietPhieuThue;
import DTO.DTO_PhieuPhat;
import DTO.DTO_PhieuThue;
import static GUI.pnl_CT_PhieuPhat.cbbLoiPhat;
import static GUI.pnl_PhieuPhat.cbbDocGia_PP;
import static GUI.pnl_PhieuPhat.cbbNhanVien_PP;
import static GUI.pnl_PhieuPhat.tblSachPhat;
import static GUI.pnl_PhieuPhat.txtNgayPhat_PP;
import static GUI.pnl_PhieuPhat.txtSoPhieuPhat;
import static GUI.pnl_PhieuThue.tblSachMuon_PT;
import java.sql.ResultSet;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author Yuuki
 */
public class pnl_CT_TraSach extends javax.swing.JPanel {

    /**
     * Creates new form pnl_giahan_trasach
     */
    public pnl_CT_TraSach() {
        initComponents();
      
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane4 = new javax.swing.JScrollPane();
        tblnew = new javax.swing.JTable();
        jPanel3 = new javax.swing.JPanel();
        btnGiaHan = new javax.swing.JButton();
        btnPhat = new javax.swing.JButton();
        btnTraSach = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        tblCTPT = new javax.swing.JTable();
        jLabel1 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblSachPhat = new javax.swing.JTable();
        jLabel2 = new javax.swing.JLabel();
        btnHuy = new javax.swing.JButton();
        btnCapNhat = new javax.swing.JButton();
        jLabel15 = new javax.swing.JLabel();
        txtGhiChu = new javax.swing.JTextField();
        txtTongTien = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        txtTongTien_Giahan = new javax.swing.JTextField();
        txtTongTien_Phat = new javax.swing.JTextField();
        jLabel9 = new javax.swing.JLabel();
        cbbNhanVien_PP = new javax.swing.JComboBox<>();
        jLabel4 = new javax.swing.JLabel();

        tblnew.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Mã chi tiết", "Mã Phiếu thuê", "Mã sách", "Giá thuê", "Số lượng", "Thành tiền", "Ghi chú"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tblnew.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tblnewMouseClicked(evt);
            }
        });
        jScrollPane4.setViewportView(tblnew);

        jPanel3.setBackground(new java.awt.Color(204, 204, 204));
        jPanel3.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.RAISED));

        btnGiaHan.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        btnGiaHan.setText("Gia Hạn");
        btnGiaHan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnGiaHanActionPerformed(evt);
            }
        });

        btnPhat.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        btnPhat.setText("Phạt");
        btnPhat.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPhatActionPerformed(evt);
            }
        });

        btnTraSach.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        btnTraSach.setText("Trả Sách");
        btnTraSach.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTraSachActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap(179, Short.MAX_VALUE)
                .addComponent(btnTraSach, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(72, 72, 72)
                .addComponent(btnGiaHan, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(61, 61, 61)
                .addComponent(btnPhat, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(205, Short.MAX_VALUE))
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnGiaHan, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnPhat, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnTraSach, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 0, Short.MAX_VALUE))
        );

        tblCTPT.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Mã chi tiết", "Mã Phiếu thuê", "Mã sách", "Giá thuê", "Số lượng", "Thành tiền", "Ghi chú"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, true, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(tblCTPT);

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel1.setText("Thông tin Trả sách - Gia hạn");

        tblSachPhat.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Tên Sách", "Mã Sách", "Lỗi Phạt", "Giá Phạt", "Số Lượng", "Thành Tiền ", "Ghi Chú"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tblSachPhat.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tblSachPhatMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(tblSachPhat);

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel2.setText("Thông tin phạt");

        btnHuy.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        btnHuy.setText("Hủy");
        btnHuy.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnHuyActionPerformed(evt);
            }
        });

        btnCapNhat.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        btnCapNhat.setText("Cập nhật");
        btnCapNhat.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCapNhatActionPerformed(evt);
            }
        });

        jLabel15.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel15.setText("Ghi chú");

        txtTongTien.setEditable(false);
        txtTongTien.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        txtTongTien.setForeground(new java.awt.Color(204, 0, 0));
        txtTongTien.setText(" 0.0 đ");

        jLabel7.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel7.setText("Tổng tiền");

        jLabel8.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel8.setText("Tiền gia hạn");

        txtTongTien_Giahan.setEditable(false);
        txtTongTien_Giahan.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        txtTongTien_Giahan.setForeground(new java.awt.Color(204, 0, 0));
        txtTongTien_Giahan.setText(" 0.0 đ");

        txtTongTien_Phat.setEditable(false);
        txtTongTien_Phat.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        txtTongTien_Phat.setForeground(new java.awt.Color(204, 0, 0));
        txtTongTien_Phat.setText(" 0.0 đ");

        jLabel9.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel9.setText("Tiền phạt");

        cbbNhanVien_PP.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

        jLabel4.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        jLabel4.setText("Nhân viên");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, layout.createSequentialGroup()
                        .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 194, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jLabel8, javax.swing.GroupLayout.PREFERRED_SIZE, 82, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtTongTien_Giahan, javax.swing.GroupLayout.PREFERRED_SIZE, 229, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(jPanel3, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jScrollPane2)
                    .addComponent(jScrollPane4, javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, layout.createSequentialGroup()
                        .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 194, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE))
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jLabel7, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(jLabel15, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(txtGhiChu, javax.swing.GroupLayout.PREFERRED_SIZE, 218, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(txtTongTien, javax.swing.GroupLayout.PREFERRED_SIZE, 221, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(btnHuy, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(btnCapNhat, javax.swing.GroupLayout.PREFERRED_SIZE, 125, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel9, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 83, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(jLabel4, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 84, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(txtTongTien_Phat)
                            .addComponent(cbbNhanVien_PP, 0, 224, Short.MAX_VALUE))))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(6, 6, 6)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 127, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel1)
                .addGap(7, 7, 7)
                .addComponent(jScrollPane4, javax.swing.GroupLayout.PREFERRED_SIZE, 119, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 15, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel8, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtTongTien_Giahan, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 114, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtGhiChu, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel15, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel9, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtTongTien_Phat, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnCapNhat, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(13, 13, 13)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(cbbNhanVien_PP, javax.swing.GroupLayout.PREFERRED_SIZE, 28, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(btnHuy, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel7, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(txtTongTien, javax.swing.GroupLayout.PREFERRED_SIZE, 27, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void btnTraSachActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTraSachActionPerformed
        // TODO add your handling code here:
          int row = tblCTPT.getSelectedRow();  
          String CTPT = tblCTPT.getValueAt(row, 0).toString();  
           
                int sl = Integer.parseInt(tblCTPT.getValueAt(row, 4).toString()) - 1;
                
               if(sl < 0 ){
                    BLL.ChuyenDoi_ThongBao.ThongBao_Loi( "Số lượng sách mượn đã hết","Thông báo số lượng");
                    return;
                }else{
                //Set lại giá trị số lượng trong Table Sản phẩm
               tblCTPT.setValueAt(sl, row, 4);
               
               }  
       DefaultTableModel table1 = (DefaultTableModel)tblnew.getModel(); 
       BLL_TraSach.ChiTietPhieuThue_CapNhat(table1,1, CTPT,"Đã trả sách");
    }//GEN-LAST:event_btnTraSachActionPerformed

    private void btnGiaHanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnGiaHanActionPerformed
        // TODO add your handling code here:
         int row = tblCTPT.getSelectedRow();  
          String CTPT = tblCTPT.getValueAt(row, 0).toString();  
          
           
                int sl = Integer.parseInt(tblCTPT.getValueAt(row, 4).toString()) - 1;
                
               if(sl < 0 ){
                    BLL.ChuyenDoi_ThongBao.ThongBao_Loi( "Số lượng sách mượn đã hết","Thông báo số lượng");
                    return;
                }else{
                //Set lại giá trị số lượng trong Table Sản phẩm
               tblCTPT.setValueAt(sl, row, 4);
               
               } 
         
        DefaultTableModel table1 = (DefaultTableModel)tblnew.getModel(); 
        BLL_TraSach.ChiTietPhieuThue_CapNhat(table1,1, CTPT,"Gia hạn");
       
        double  Tong = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(txtTongTien_Giahan.getText())); 
        for (int i = 0; i < tblnew.getRowCount(); i++) {
                
//         int MaSach = Integer.parseInt(tblSachPhat.getValueAt(i, 1).toString());
                
         String GhiChu = tblnew.getValueAt(i, 6).toString();
         
          if(GhiChu.equals("Gia hạn")){
               
              String thanhtien = tblnew.getValueAt(i, 5).toString();
              double  Tong1 = Tong + Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(thanhtien));             
              txtTongTien_Giahan.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tong1));
              
         String  TienPhat = txtTongTien_Phat.getText(); 
         String  TienGH   = txtTongTien_Giahan.getText();
         
         double  TienP    = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienPhat));         
         double  Tien_GH  = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienGH));         
         double  Tongq    = TienP + Tien_GH;        
           
       txtTongTien.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tongq));  
               
         }else{
                         
          }
        
             
       
       
        }
   
       
       
    }//GEN-LAST:event_btnGiaHanActionPerformed

    private void btnPhatActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPhatActionPerformed
        // TODO add your handling code here:
         int row = tblCTPT.getSelectedRow();  
          String CTPT = tblCTPT.getValueAt(row, 0).toString();   
          String MaSach = tblCTPT.getValueAt(row, 2).toString();  
           // show hộp thoại xác nhận
          int luachon =  JOptionPane.showConfirmDialog(new JFrame(), DuAn1.frm_Phat, "Nhập thông tin phạt",
                                                             JOptionPane.YES_NO_OPTION);
       
        // Kiểm tra xem người dùng bấm yes hay no
            if(luachon == JOptionPane.YES_OPTION){
                
           int SL_phat =Integer.parseInt(DuAn1.frm_Phat.spnSoLuongPhat.getValue().toString());
           int sl = Integer.parseInt(tblCTPT.getValueAt(row, 4).toString()) - SL_phat;
                               if(sl < 0 ){
                    BLL.ChuyenDoi_ThongBao.ThongBao_Loi( "Số lượng sách mượn không đủ","Thông báo số lượng");
                    return;
                }else{
                //Set lại giá trị số lượng trong Table Sản phẩm
               tblCTPT.setValueAt(sl, row, 4);
               
          double LoiPhat = 0;
          int Loi = cbbLoiPhat.getSelectedIndex();
          if(Loi==0 || Loi==1){
              LoiPhat = 0.3; // phạt =*30% giá trị sách
          }else if(Loi==2){
               LoiPhat = 0.6;
           }else{
              LoiPhat = 1;
          }
                     
             String GhiChu = DuAn1.frm_Phat.txtGhiChu_CTPP.getText();
         
                    
          //     Đổ dữ liệu vào bảng Chi Tiết hóa đơn
          DefaultTableModel table1 = (DefaultTableModel)tblSachPhat.getModel();
          BLL_PhieuPhat.DuLieuDatabase_CTHD(table1, MaSach, LoiPhat, SL_phat, GhiChu);
               } 
         }
            
            
         String  TienPhat = BLL_PhieuThue.TinhTongTien(tblSachPhat, 5);
         String  TienGH   = txtTongTien_Giahan.getText();
         
         txtTongTien_Phat.setText(TienPhat); 
         
         double  TienP    = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienPhat));         
         double  Tien_GH  = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienGH));         
         double  Tong     = TienP + Tien_GH;        
           
        txtTongTien.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tong));
       
    }//GEN-LAST:event_btnPhatActionPerformed

    private void tblnewMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblnewMouseClicked
        // TODO add your handling code here:
         int row = tblnew.getSelectedRow();
         DefaultTableModel tblNew = (DefaultTableModel)tblnew.getModel();

        int SL = Integer.parseInt(tblNew.getValueAt(row, 4).toString());
        String maSp = tblNew.getValueAt(row,0).toString();

        DefaultTableModel tblCTPT = (DefaultTableModel)pnl_CT_TraSach.tblCTPT.getModel();
        double  Tong = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(txtTongTien_Giahan.getText())); 
        for(int i = 0; i < tblCTPT.getRowCount(); i++){
            String maSpBangSP = tblCTPT.getValueAt(i, 0).toString();
            if(maSpBangSP.equals(maSp)){
                
                
                String GhiChu = tblnew.getValueAt(i, 6).toString();
                 if(GhiChu.equals("Gia hạn")){
               
              String thanhtien = tblnew.getValueAt(i, 5).toString();
              double  Tong1 = Tong - Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(thanhtien));             
              txtTongTien_Giahan.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tong1));
              
         String  TienPhat = txtTongTien_Phat.getText(); 
         String  TienGH   = txtTongTien_Giahan.getText();
         
         double  TienP    = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienPhat));         
         double  Tien_GH  = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienGH));         
         double  Tongq    = TienP + Tien_GH;        
           
       txtTongTien.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tongq));  
               
         }else{
                         
          }
                int soLuongBangSP = Integer.parseInt(tblCTPT.getValueAt(i, 4).toString());
                tblCTPT.setValueAt((soLuongBangSP + SL ), i, 4);
            }

        }
        tblnew.removeRowSelectionInterval(row, row);
        BLL_PhieuThue.RemoveRowInTable(tblnew, row);
       
    }//GEN-LAST:event_tblnewMouseClicked

    private void tblSachPhatMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblSachPhatMouseClicked
        // TODO add your handling code here:
           int row = tblSachPhat.getSelectedRow();
         DefaultTableModel table = (DefaultTableModel)tblSachPhat.getModel();

        
        int SL = Integer.parseInt(table.getValueAt(row, 4).toString());
        String maSp = table.getValueAt(row,1).toString();

        DefaultTableModel tbModelSP = (DefaultTableModel)tblCTPT.getModel();
        double  Tong = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(txtTongTien_Phat.getText())); 
        for(int i = 0; i < tbModelSP.getRowCount(); i++){
            String maSpBangSP = tbModelSP.getValueAt(i, 2).toString();
            if(maSpBangSP.equals(maSp)){
                int soLuongBangSP = Integer.parseInt(tbModelSP.getValueAt(i, 4).toString());
                tbModelSP.setValueAt((soLuongBangSP + SL ), i, 4);
                
        String thanhtien = table.getValueAt(i, 5).toString();
        double  Tong1 = Tong - Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(thanhtien));             
       
        txtTongTien_Phat.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tong1));
              
         String  TienPhat = txtTongTien_Phat.getText(); 
         String  TienGH   = txtTongTien_Giahan.getText();
         
         double  TienP    = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienPhat));         
         double  Tien_GH  = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(TienGH));         
         double  Tongq    = TienP + Tien_GH;        
           
        txtTongTien.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(Tongq)); 
            }

        }
        tblSachPhat.removeRowSelectionInterval(row, row);
        BLL_PhieuThue.RemoveRowInTable(tblSachPhat, row);
        txtTongTien_Phat.setText(BLL_PhieuThue.TinhTongTien(tblSachPhat, 5) + "");
       
    }//GEN-LAST:event_tblSachPhatMouseClicked

    private void btnHuyActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnHuyActionPerformed
        // TODO add your handling code here:
        DefaultTableModel table1 = (DefaultTableModel)tblSachPhat.getModel();
        table1.setRowCount(0);
        
        DefaultTableModel newtbl = (DefaultTableModel)tblnew.getModel();
        newtbl.setRowCount(0);
        
       txtTongTien.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(0));
       txtTongTien_Giahan.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(0));
       txtTongTien_Phat.setText(BLL.ChuyenDoi_ThongBao.TienVietNam(0));
       txtGhiChu.setText("");
    }//GEN-LAST:event_btnHuyActionPerformed

    private void btnCapNhatActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCapNhatActionPerformed
        // TODO add your handling code here:
   
      // Cập nhật trả sách -- chi tiết phiếu thuê
      DefaultTableModel tblNew = (DefaultTableModel)tblnew.getModel();
      for (int i = 0; i < tblnew.getRowCount(); i++) {
       
         String GhiChuCTPP = tblNew.getValueAt(i, 6).toString();
          
     if(GhiChuCTPP.equals("Đã trả sách")){
            
                int MaCTPhieuThue = Integer.parseInt(tblnew.getValueAt(i, 0).toString());
                int MaPhieuThue = Integer.parseInt(tblnew.getValueAt(i, 1).toString());
                int MaSach = Integer.parseInt(tblnew.getValueAt(i, 2).toString());
                double giaThue = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(tblnew.getValueAt(i, 3).toString()));
                int SoLuong= Integer.parseInt(tblnew.getValueAt(i, 4).toString());
                double ThanhTien = giaThue * SoLuong;
                
                DTO_ChiTietPhieuThue ctpp = new DTO_ChiTietPhieuThue(MaCTPhieuThue,MaPhieuThue, MaSach, giaThue, SoLuong, ThanhTien, GhiChuCTPP);
                DAL_ChiTietPhieuThue.Sua_ChiTietPhieuThue(ctpp);
           
     }else{         
      // Cập nhật gia hạn -- chi tiết phiếu thuê
                int MaCTPhieuThue = Integer.parseInt(tblnew.getValueAt(i, 0).toString());
                int MaPhieuThue = Integer.parseInt(tblnew.getValueAt(i, 1).toString());
                int MaSach = Integer.parseInt(tblnew.getValueAt(i, 2).toString());
                double giaThue = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(tblnew.getValueAt(i, 3).toString()));
                int SoLuong= Integer.parseInt(tblnew.getValueAt(i, 4).toString());
                double ThanhTien = giaThue * SoLuong;
                
                DTO_ChiTietPhieuThue ctpp = new DTO_ChiTietPhieuThue(MaCTPhieuThue,MaPhieuThue, MaSach, giaThue, SoLuong, ThanhTien, "Gia hạn sách");
                DAL_ChiTietPhieuThue.Sua_ChiTietPhieuThue(ctpp);
                
                 // Cập nhật gia hạn -- phiếu thuê
                 
            int maNV;
            maNV = Integer.parseInt(BLL_Combobox.getSelectedItemID_Yuu(cbbNhanVien_PP));
            String ngay = BLL.BLL_PhieuThue.UpDownDate(); // ngày cuộn lên 5 ngày so vs ngày hiện tại
            System.out.println(ngay);
            double TongTien = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(txtTongTien_Giahan.getText()));
         
         String Tong2 = BLL_PhieuThue.TinhTongTien(tblCTPT, 5);
         double Tong1= Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(Tong2));
         
         double Tong_SUM= TongTien + Tong1; // tổng tiền = tiền trong hóa đơn cũ + tiền sách gia hạn mới
         System.out.println(Tong1);
         System.out.println(Tong_SUM);
                 
         
      //      System.out.println(Tong_tien);
            DTO_PhieuThue px = new DTO_PhieuThue(maNV, ngay, Tong_SUM, txtGhiChu.getText(),MaPhieuThue);
            DAL_PhieuThue.Sua_PhieuThue_giahan(px);
  }
}
      // Cập nhật phạt  -- chi tiết phiếu phạt - phiếu phạt
        
        //Thêm dữ liệu vào bảng Phiếu phạt
         String SoPhieuPhat, ngayTao,GhiChu;
         SoPhieuPhat = BLL_PhieuPhat.TaoSoHoaDon();
         String MaPhieuThue = (tblCTPT.getValueAt(1, 1).toString());
         
         int Madg = BLL.BLL_PhieuPhat.LayMaDGtusoHG(MaPhieuThue);
         
         int maNV = Integer.parseInt(BLL_Combobox.getSelectedItemID_Yuu(cbbNhanVien_PP));
            
         ngayTao = BLL.BLL_PhieuThue.TaoNgayLapHoaDon();  
         GhiChu =  txtGhiChu.getText();
         
         double TongTien = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(txtTongTien_Phat.getText()));
        
         try {
            
             DTO_PhieuPhat px = new DTO_PhieuPhat(SoPhieuPhat, Madg, maNV, ngayTao, TongTien, GhiChu);
             DAL_PhieuPhat.Them_PhieuPhat(px);
            
                       
            //-----------------------------------------------------
          
            //Thêm dữ liệu vào bảng chi tiết phiếu phạt
            
            int MaPhieuPhat = BLL_PhieuPhat.LayMaHDTuSoHD(SoPhieuPhat);
           
         for (int i = 0; i < tblSachPhat.getRowCount(); i++) {
                
        int MaSach = Integer.parseInt(tblSachPhat.getValueAt(i, 1).toString());
                
         String LoiP= tblSachPhat.getValueAt(i, 2).toString();
          int LoiPhat = 0;
          
          if(LoiP.equals("Trả muộn (-30%)")){
             LoiPhat = 0;
        }else if(LoiP.equals("Hỏng nặng (từ 3 tờ trở lên - 60%)")){
              LoiPhat = 1;
      
         }else if(LoiP.equals("Hỏng nặng (từ 3 tờ trở lên - 60%)")){
              LoiPhat = 2;
         }else{
            
             LoiPhat = 3;
          }
          
                System.out.println(LoiPhat);
                int SoLuong= Integer.parseInt(tblSachPhat.getValueAt(i, 4).toString());                
                double giaPhat = Double.parseDouble(BLL.ChuyenDoi_ThongBao.TienTeVeString(tblSachPhat.getValueAt(i, 3).toString()));
                double ThanhTien = giaPhat * SoLuong;
               String GhiChuCTPP = tblSachPhat.getValueAt(i, 6).toString();
                DTO_ChiTietPhieuPhat ctpp = new DTO_ChiTietPhieuPhat(MaPhieuPhat, MaSach, LoiPhat, giaPhat, SoLuong, ThanhTien, GhiChuCTPP);
                DAL_ChiTietPhieuPhat.Them_ChiTietPhieuPhat(ctpp);
            }
            
                 
             System.out.println("thành công");
        } catch (Exception e) {
            System.out.println(e.toString());

       }
    }//GEN-LAST:event_btnCapNhatActionPerformed
   
 

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCapNhat;
    private javax.swing.JButton btnGiaHan;
    private javax.swing.JButton btnHuy;
    private javax.swing.JButton btnPhat;
    private javax.swing.JButton btnTraSach;
    public static javax.swing.JComboBox<String> cbbNhanVien_PP;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane4;
    static javax.swing.JTable tblCTPT;
    public static javax.swing.JTable tblSachPhat;
    static javax.swing.JTable tblnew;
    private javax.swing.JTextField txtGhiChu;
    public static javax.swing.JTextField txtTongTien;
    public static javax.swing.JTextField txtTongTien_Giahan;
    public static javax.swing.JTextField txtTongTien_Phat;
    // End of variables declaration//GEN-END:variables
}
